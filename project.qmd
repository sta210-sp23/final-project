---
title: "Final Project - Predicting March Madness"
author: "Anmol Sapru and Rohit Gunda"
format: pdf
---

```{r load-libraries-data, message = FALSE, warning = FALSE}

library(tidyverse)
library(tidymodels)
library(Stat2Data)
library(caret)
library(leaps)
library(MASS)

cbb <- read_csv("data/cbb.csv") 
sportsreference <- read_csv("data/sportsreference.csv")

#Remove non-postseason teams and R68 losers
cbb <- cbb[!is.na(cbb$POSTSEASON),]
cbb <- filter(cbb, !grepl("R68", POSTSEASON))

#Cleaning up variable names, variables, etc
cbb$POSTSEASON <- str_trim(cbb$POSTSEASON, side = c("both"))
cbb <- rename(cbb, march_madness = POSTSEASON) 

cbb <- cbb |>
  mutate(march_madness = case_when(
    march_madness == "Sweet Sixteen" ~ "S16",
    march_madness == "Elite Eight" ~ "E8",
    march_madness == "Final Four" ~ "F4",
    march_madness == "Finals" ~ "2ND",
    march_madness == "CHAMPS" ~ "Champions",
    TRUE ~ march_madness
  ))

cbb <- left_join(cbb, sportsreference, by = c("TEAM" = "School", "YEAR" = "Year"))
```

```{r round-separation}

#separated each row by round for determining differences
cbb <- mutate(cbb, round_64 = if_else(march_madness == "R64", FALSE, TRUE))
round_64 <- cbb

cbb <- mutate(cbb, round_32 = 
         case_when(march_madness == "R32" ~ FALSE,
         march_madness %in% c("S16", "E8", "F4", "2ND", "Champions") ~ TRUE,
         TRUE ~ NA))
round_32 <- cbb[!is.na(cbb$round_32),]

cbb <- mutate(cbb, sweet_sixteen = 
         case_when(march_madness == "S16" ~ FALSE,
         march_madness %in% c("E8", "F4", "2ND", "Champions") ~ TRUE,
         TRUE ~ NA))
sweet_sixteen <- cbb[!is.na(cbb$sweet_sixteen),]

cbb <- mutate(cbb, elite_eight = 
         case_when(march_madness == "E8" ~ FALSE,
         march_madness %in% c("F4", "2ND", "Champions") ~ TRUE,
         TRUE ~ NA))
elite_eight <- cbb[!is.na(cbb$elite_eight),]

cbb <- mutate(cbb, final_four = 
         case_when(march_madness == "F4" ~ FALSE,
         march_madness %in% c("2ND", "Champions") ~ TRUE,
         TRUE ~ NA))
final_four <- cbb[!is.na(cbb$final_four),]

cbb <- mutate(cbb, champ_game = 
         case_when(march_madness == "2ND" ~ FALSE,
         march_madness %in% c("Champions") ~ TRUE,
         TRUE ~ NA))
champ_game <- cbb[!is.na(cbb$champ_game),]
```

```{r round-64-model}

round_64_max <- glm(round_64 ~ ADJOE + ADJDE + `EFG%` + `EFGD%` +
                      TOR + TORD + ORB + DRB + FTR + FTRD + `2P%` + 
                      `2P%D` + `3P%` + `3P%D` + `ADJ T.` + 
                      `Overall SRS` + `Overall SOS` + `Conf. W-L%` + 
                      `Home W-L%` + `Away W-L%` + `AVG PPG` + 
                      `AVG DPPG` + `AVG PD` + `AST/TOV` + `PF/G` + 
                      ADJOE*ADJDE + `EFG%`*`EFGD%` + TOR*TORD + 
                      ORB*DRB + FTR*FTRD + `2P%`*`2P%D` + 
                      `2P%`*`3P%` + `3P%`*`3P%D` + `AVG PPG`*`AVG DPPG`,     
                      data = round_64,
                      family = "binomial")

round_64_min <- glm(round_64 ~ 1,
                    data = round_64,
                    family = "binomial")

round_64_model <- stepAIC(round_64_max,
        scope = list(lower = round_64_min, upper = round_64_max),
        data = round_64, direction = "both")
```

```{r round-32-model}

round_32_max <- glm(round_32 ~ ADJOE + ADJDE + `EFG%` + `EFGD%` +
                      TOR + TORD + ORB + DRB + FTR + FTRD + `2P%` + 
                      `2P%D` + `3P%` + `3P%D` + `ADJ T.` + 
                      `Overall SRS` + `Overall SOS` + `Conf. W-L%` + 
                      `Home W-L%` + `Away W-L%` + `AVG PPG` + 
                      `AVG DPPG` + `AVG PD` + `AST/TOV` + `PF/G` + 
                      ADJOE*ADJDE + `EFG%`*`EFGD%` + TOR*TORD + 
                      ORB*DRB + FTR*FTRD + `2P%`*`2P%D` + 
                      `2P%`*`3P%` + `3P%`*`3P%D` + `AVG PPG`*`AVG DPPG`,
                      data = round_32,
                      family = "binomial")

round_32_min <- glm(round_32 ~ 1,
                    data = round_32,
                    family = "binomial")

round_32_model <- stepAIC(round_32_max,
        scope = list(lower = round_32_min, 
                     upper = round_32_max),
        data = round_32, direction = "both")
```

```{r sweet-sixteen-model}

sweet_sixteen_max <- glm(sweet_sixteen ~ ADJOE + ADJDE + `EFG%` + `EFGD%` +
                      TOR + TORD + ORB + DRB + FTR + FTRD + `2P%` + 
                      `2P%D` + `3P%` + `3P%D` + `ADJ T.` + 
                      `Overall SRS` + `Overall SOS` + `Conf. W-L%` + 
                      `Home W-L%` + `Away W-L%` + `AVG PPG` + 
                      `AVG DPPG` + `AVG PD` + `AST/TOV` + `PF/G` + 
                      ADJOE*ADJDE + `EFG%`*`EFGD%` + TOR*TORD + 
                      ORB*DRB + FTR*FTRD + `2P%`*`2P%D` + 
                      `2P%`*`3P%` + `3P%`*`3P%D` + `AVG PPG`*`AVG DPPG`,
                        data = sweet_sixteen,
                        family = "binomial")

sweet_sixteen_min <- glm(sweet_sixteen ~ 1,
                    data = sweet_sixteen,
                    family = "binomial")

sweet_sixteen_model <- stepAIC(sweet_sixteen_max,
        scope = list(lower = sweet_sixteen_min,
                     upper = sweet_sixteen_max),
        data = sweet_sixteen, direction = "both")
```

```{r}

`2023sr` <- read_csv("data/2023sportsreference.csv")
`2023analytics` <- read_csv("data/2023marchmadness.csv")

`2023marchmadness` <- left_join(`2023analytics`, `2023sr`, by = c("TEAM" = "School"))

tibble(predict(round_64_max, `2023marchmadness`)) |>
  mutate(rank = seq(1:63)) |>
  left_join(mutate(`2023marchmadness`, rank = seq(1:63))) |>
  arrange(desc(predict(round_64_max, `2023marchmadness`)))

tibble(predict(round_32_max, `2023marchmadness`)) |>
  mutate(rank = seq(1:63)) |>
  left_join(mutate(`2023marchmadness`, rank = seq(1:63))) |>
  arrange(desc(predict(round_32_max, `2023marchmadness`)))

tibble(predict(sweet_sixteen_max, `2023marchmadness`)) |>
  mutate(rank = seq(1:63)) |>
  left_join(mutate(`2023marchmadness`, rank = seq(1:63))) |>
  arrange(desc(predict(sweet_sixteen_max, `2023marchmadness`)))

tibble(predict(final_four_max, `2023marchmadness`)) |>
  mutate(rank = seq(1:63)) |>
  left_join(mutate(`2023marchmadness`, rank = seq(1:63))) |>
  arrange(desc(predict(final_four_max, `2023marchmadness`)))
```
